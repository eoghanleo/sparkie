name: "discord.updates"

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - closed
  issues:
    types:
      - opened
  release:
    types:
      - published

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Build message
        id: message
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          REF_NAME: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          COMPARE_URL: ${{ github.event.compare }}
          HEAD_MESSAGE: ${{ github.event.head_commit.message }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_MERGED: ${{ github.event.pull_request.merged }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
        run: |
          set -euo pipefail

          escape_json() {
            local s="$1"
            s=${s//\\/\\\\}
            s=${s//\"/\\\"}
            s=${s//$'\n'/\\n}
            s=${s//$'\r'/}
            printf '%s' "$s"
          }

          case "$EVENT_NAME" in
            push)
              short_sha="${SHA:0:7}"
              subject="$(printf "%s\n" "${HEAD_MESSAGE:-}" | head -n 1)"
              if [ -z "$subject" ]; then
                subject="Update pushed"
              fi
              printf -v msg "ðŸŸª PHOSPHENE REACTOR - Update Live\nRepo: %s@%s\nCommit: %s â€” %s\nBy: %s\nCompare: %s" \
                "$REPO" "$REF_NAME" "$short_sha" "$subject" "$ACTOR" "$COMPARE_URL"
              ;;
            pull_request)
              if [ "${PR_MERGED}" != "true" ]; then
                echo "skip=true" >> "$GITHUB_OUTPUT"
                exit 0
              fi
              author="${PR_AUTHOR:-unknown}"
              printf -v msg ":white_check_mark: PHOSPHENE WORKSHOP â€” PR merged\nPR: #%s â€” %s\nBy: %s\nLink: %s" \
                "$PR_NUMBER" "$PR_TITLE" "$author" "$PR_URL"
              ;;
            issues)
              author="${ISSUE_AUTHOR:-unknown}"
              printf -v msg ":bookmark_tabs: PHOSPHENE WORKSHOP â€” Issue opened\nIssue: #%s â€” %s\nBy: %s\nLink: %s" \
                "$ISSUE_NUMBER" "$ISSUE_TITLE" "$author" "$ISSUE_URL"
              ;;
            release)
              name_part="$RELEASE_NAME"
              if [ -z "$name_part" ]; then
                name_part="$RELEASE_TAG"
              fi
              printf -v msg ":rocket: PHOSPHENE WORKSHOP â€” Release published\nTag: %s\nName: %s\nLink: %s" \
                "$RELEASE_TAG" "$name_part" "$RELEASE_URL"
              ;;
            *)
              printf -v msg ":bell: PHOSPHENE WORKSHOP â€” Event %s\nRepo: %s" \
                "$EVENT_NAME" "$REPO"
              ;;
          esac

          escaped_msg="$(escape_json "$msg")"
          payload="{\"content\":\"${escaped_msg}\"}"

          {
            echo "payload<<EOF"
            echo "$payload"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
      - name: Send to Discord
        if: ${{ steps.message.outputs.skip != 'true' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -euo pipefail
          if [ -z "${DISCORD_WEBHOOK_URL}" ]; then
            echo "DISCORD_WEBHOOK_URL is not set"
            exit 1
          fi
          payload='${{ steps.message.outputs.payload }}'
          curl -sS -X POST -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK_URL"
