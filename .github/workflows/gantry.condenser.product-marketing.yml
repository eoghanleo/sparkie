name: "gantry.condenser.product-marketing"

on:
  pull_request:
    types: [closed]
    paths:
      - "phosphene/signals/bus.jsonl"
      - "phosphene/domains/product-marketing/**"
  check_suite:
    types: [completed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to approve"
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: instrument-condenser-product-marketing-${{ inputs.pr_number || github.event.check_suite.pull_requests[0].number || github.run_id }}
  cancel-in-progress: true

jobs:
  emit_merge_complete_on_merge:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main (post-merge)
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: false

      - name: Emit merge_complete signal (product-marketing) to main bus
        shell: bash
        env:
          PHOSPHENE_HUMAN_TOKEN: ${{ secrets.PHOSPHENE_HUMAN_TOKEN }}
        run: |
          set -euo pipefail

          export PHOSPHENE_GANTRY_WRITE_ALLOWLIST=$'phosphene/signals/**\nphosphene/signals/indexes/**'
          bash phosphene/phosphene-core/bin/gantry_write_allowlist_guard.sh check

          if [[ -z "${PHOSPHENE_HUMAN_TOKEN:-}" ]]; then
            echo "PHOSPHENE: missing PHOSPHENE_HUMAN_TOKEN; refusing to push bus changes."
            exit 1
          fi

          domain="product-marketing"
          lane="beryl"
          bus="phosphene/signals/bus.jsonl"
          pr_number="${{ github.event.pull_request.number }}"
          base_sha="${{ github.event.pull_request.base.sha }}"
          merge_sha="${{ github.event.pull_request.merge_commit_sha }}"
          [[ -n "${pr_number:-}" ]] || { echo "Missing PR number"; exit 2; }
          [[ -n "${base_sha:-}" ]] || { echo "Missing base sha"; exit 2; }
          [[ -n "${merge_sha:-}" ]] || { echo "Missing merge sha"; exit 2; }

          git fetch origin "$merge_sha" --force >/dev/null 2>&1 || true

          git diff --unified=0 "$base_sha" "$merge_sha" -- "$bus" \
            | grep -E '^\+' \
            | grep -vE '^\+\+\+' \
            | sed -E 's/^\+//' \
            | grep -E '^\{' \
            > /tmp/merge_new_lines.txt || true

          approve_line="$(node -e '
            const fs=require("fs");
            const raw=fs.existsSync("/tmp/merge_new_lines.txt")?fs.readFileSync("/tmp/merge_new_lines.txt","utf8"):"";
            const lines=raw.split(/\n/).map(l=>l.trim()).filter(Boolean);
            for (const line of lines) {
              try {
                const j=JSON.parse(line);
                if (j.signal_type==="phosphene.detector.product-marketing.approve.v1") { process.stdout.write(line); process.exit(0); }
              } catch {}
            }
            process.exit(1);
          ' && true || true)"

          if [[ -z "${approve_line:-}" ]]; then
            echo "PHOSPHENE: no detector approve signal found in merge diff; skip merge_complete."
            exit 0
          fi

          work_id="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.work_id||""));' "$approve_line")"
          issue_number="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.issue_number||"0"));' "$approve_line")"
          approve_signal_id="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.signal_id||""));' "$approve_line")"
          lane_in="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.lane||""));' "$approve_line")"
          if [[ -n "${lane_in:-}" ]]; then lane="$lane_in"; fi

          [[ -n "${work_id:-}" ]] || { echo "Missing work_id in approve signal"; exit 1; }
          [[ -n "${approve_signal_id:-}" ]] || { echo "Missing approve signal_id"; exit 1; }

          output_key="merge_complete:${domain}:pr:${pr_number}"
          signal_id="$(bash phosphene/phosphene-core/bin/signal_hash.sh signal-id --run-marker "$work_id" --output-key "$output_key" --parent "$approve_signal_id")"
          if grep -qF "\"signal_id\":\"${signal_id}\"" "$bus"; then
            echo "PHOSPHENE: merge_complete already present (idempotent): $signal_id"
            exit 0
          fi

          created_utc="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          line="{\"signal_version\":1,\"signal_id\":\"${signal_id}\",\"signal_type\":\"phosphene.merge_complete.${domain}.v1\",\"work_id\":\"${work_id}\",\"domain\":\"${domain}\",\"issue_number\":${issue_number},\"pr_number\":${pr_number},\"lane\":\"${lane}\",\"parents\":[\"${approve_signal_id}\"],\"run_marker\":\"${work_id}\",\"output_key\":\"${output_key}\",\"created_utc\":\"${created_utc}\"}"
          bash phosphene/phosphene-core/bin/signal_bus.sh append --bus "$bus" --line "$line"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${PHOSPHENE_HUMAN_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git add "$bus"
          git commit -m "PHOSPHENE: emit merge_complete ${domain} (PR #${pr_number})" || exit 0
          git push origin HEAD:main

  approve_on_check_suite:
    if: github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Resolve PR from check_suite payload
        id: ctx
        uses: actions/github-script@v7
        with:
          script: |
            const prs = Array.isArray(context.payload.check_suite?.pull_requests) ? context.payload.check_suite.pull_requests : [];
            const pr_number = Number(prs?.[0]?.number || 0);
            if (!pr_number) {
              core.notice("PHOSPHENE: check_suite has no PR context; skip.");
              core.setOutput("has_pr", "0");
              return;
            }
            core.setOutput("has_pr", "1");
            core.setOutput("pr_number", String(pr_number));

      - name: Load PR metadata
        id: pr
        if: steps.ctx.outputs.has_pr == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number("${{ steps.ctx.outputs.pr_number }}");
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: pr_number });
            const state = String(pr.data.mergeable_state || "").toLowerCase();
            core.setOutput("mergeable_state", state);
            core.setOutput("head_ref", String(pr.data.head.ref));
            core.setOutput("base_ref", String(pr.data.base.ref));
            core.setOutput("head_sha", String(pr.data.head.sha));
            core.setOutput("is_draft", pr.data.draft ? "1" : "0");
            core.setOutput("is_open", String(pr.data.state || "").toLowerCase() === "open" ? "1" : "0");

      - name: Checkout PR head (by SHA)
        if: steps.ctx.outputs.has_pr == '1' && steps.pr.outputs.is_open == '1'
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.pr.outputs.head_sha }}
          fetch-depth: 0
          persist-credentials: true

      - name: Extract approve signal (product-marketing) from PR diff
        id: approve
        if: steps.ctx.outputs.has_pr == '1' && steps.pr.outputs.is_open == '1'
        shell: bash
        run: |
          set -euo pipefail
          bus="phosphene/signals/bus.jsonl"
          base="${{ steps.pr.outputs.base_ref }}"
          git fetch origin "$base:refs/remotes/origin/$base" --force
          git diff --unified=0 "origin/$base"...HEAD -- "$bus" \
            | grep -E '^\+' \
            | grep -vE '^\+\+\+' \
            | sed -E 's/^\+//' \
            | grep -E '^\{' \
            > /tmp/pr_new_lines.txt || true

          approve_line="$(node -e '
            const fs=require("fs");
            const raw=fs.existsSync("/tmp/pr_new_lines.txt")?fs.readFileSync("/tmp/pr_new_lines.txt","utf8"):"";
            const lines=raw.split(/\n/).map(l=>l.trim()).filter(Boolean);
            for (const line of lines) {
              try {
                const j=JSON.parse(line);
                if (j.signal_type==="phosphene.detector.product-marketing.approve.v1") {
                  process.stdout.write(line);
                  process.exit(0);
                }
              } catch {}
            }
            process.exit(1);
          ' && true || true)"

          if [[ -z "${approve_line:-}" ]]; then
            echo "has_approve=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          work_id="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.work_id||""));' "$approve_line")"
          issue_number="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.issue_number||""));' "$approve_line")"
          approve_signal_id="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.signal_id||""));' "$approve_line")"

          echo "has_approve=1" >> "$GITHUB_OUTPUT"
          echo "work_id=$work_id" >> "$GITHUB_OUTPUT"
          echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"
          echo "approve_signal_id=$approve_signal_id" >> "$GITHUB_OUTPUT"

      - name: Ensure condenser approve signal exists (product-marketing)
        id: condenser_signal
        if: steps.ctx.outputs.has_pr == '1' && steps.approve.outputs.has_approve == '1' && steps.pr.outputs.mergeable_state == 'clean' && steps.pr.outputs.is_draft != '1' && steps.pr.outputs.is_open == '1'
        shell: bash
        run: |
          set -euo pipefail
          bus="phosphene/signals/bus.jsonl"
          pr_number="${{ steps.ctx.outputs.pr_number }}"
          work_id="${{ steps.approve.outputs.work_id }}"
          issue_number="${{ steps.approve.outputs.issue_number }}"
          approve_signal_id="${{ steps.approve.outputs.approve_signal_id }}"
          lane="beryl"
          domain="product-marketing"
          output_key="condenser:approve:${domain}:pr:${pr_number}"

          signal_id="$(bash phosphene/phosphene-core/bin/signal_hash.sh signal-id --run-marker "$work_id" --output-key "$output_key" --parent "$approve_signal_id")"
          if grep -qF "\"signal_id\":\"${signal_id}\"" "$bus"; then
            echo "has_condenser_signal=1" >> "$GITHUB_OUTPUT"
            echo "did_append=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          created_utc="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          line="{\"signal_version\":1,\"signal_id\":\"${signal_id}\",\"signal_type\":\"phosphene.condenser.product-marketing.approve.v1\",\"work_id\":\"${work_id}\",\"domain\":\"${domain}\",\"issue_number\":${issue_number},\"pr_number\":${pr_number},\"lane\":\"${lane}\",\"parents\":[\"${approve_signal_id}\"],\"run_marker\":\"${work_id}\",\"output_key\":\"${output_key}\",\"ok\":true,\"created_utc\":\"${created_utc}\"}"
          bash phosphene/phosphene-core/bin/signal_bus.sh append --bus "$bus" --line "$line"
          echo "has_condenser_signal=1" >> "$GITHUB_OUTPUT"
          echo "did_append=1" >> "$GITHUB_OUTPUT"

      - name: Commit + push condenser approve signal (product-marketing)
        if: steps.condenser_signal.outputs.did_append == '1'
        shell: bash
        env:
          PHOSPHENE_HUMAN_TOKEN: ${{ secrets.PHOSPHENE_HUMAN_TOKEN }}
        run: |
          set -euo pipefail
          export PHOSPHENE_GANTRY_WRITE_ALLOWLIST=$'phosphene/signals/**\nphosphene/signals/indexes/**'
          bash phosphene/phosphene-core/bin/gantry_write_allowlist_guard.sh check

          if [[ -z "${PHOSPHENE_HUMAN_TOKEN:-}" ]]; then
            echo "PHOSPHENE: missing PHOSPHENE_HUMAN_TOKEN; refusing to push bus changes."
            exit 1
          fi

          pr_number="${{ steps.ctx.outputs.pr_number }}"
          head_ref="${{ steps.pr.outputs.head_ref }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${PHOSPHENE_HUMAN_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git add "phosphene/signals/bus.jsonl"
          git commit -m "PHOSPHENE: condenser approve product-marketing for PR #${pr_number}" || exit 0
          git push origin "HEAD:${head_ref}"

      - name: Check for existing condenser approval
        id: review
        if: steps.ctx.outputs.has_pr == '1' && steps.approve.outputs.has_approve == '1' && steps.condenser_signal.outputs.has_condenser_signal == '1' && steps.condenser_signal.outputs.did_append != '1' && steps.pr.outputs.mergeable_state == 'clean' && steps.pr.outputs.is_draft != '1' && steps.pr.outputs.is_open == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number("${{ steps.ctx.outputs.pr_number }}");
            const reviews = await github.rest.pulls.listReviews({ owner, repo, pull_number: pr_number, per_page: 100 });
            const already = (reviews.data || []).some(r => r.user?.login === "github-actions[bot]" && r.state === "APPROVED");
            core.setOutput("already_approved", already ? "1" : "0");

      - name: Approve PR (condenser)
        if: steps.ctx.outputs.has_pr == '1' && steps.approve.outputs.has_approve == '1' && steps.condenser_signal.outputs.has_condenser_signal == '1' && steps.condenser_signal.outputs.did_append != '1' && steps.pr.outputs.mergeable_state == 'clean' && steps.pr.outputs.is_draft != '1' && steps.pr.outputs.is_open == '1' && steps.review.outputs.already_approved != '1'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number("${{ steps.ctx.outputs.pr_number }}");
            await github.rest.pulls.createReview({
              owner,
              repo,
              pull_number: pr_number,
              event: "APPROVE",
              body: "PHOSPHENE: condenser approval (checks green).",
            });

  approve_dispatch:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Load PR metadata
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number((context?.payload?.inputs || {})["pr_number"]);
            if (!pr_number) throw new Error("Missing required workflow_dispatch input: pr_number");
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: pr_number });
            core.setOutput("pr_number", String(pr_number));
            core.setOutput("head_ref", String(pr.data.head.ref));
            core.setOutput("head_sha", String(pr.data.head.sha));
            core.setOutput("base_ref", String(pr.data.base.ref));
            core.setOutput("mergeable_state", String(pr.data.mergeable_state || "").toLowerCase());
            core.setOutput("is_draft", pr.data.draft ? "1" : "0");
            core.setOutput("is_open", String(pr.data.state || "").toLowerCase() === "open" ? "1" : "0");

      - name: Checkout PR head (by SHA)
        if: steps.pr.outputs.is_open == '1'
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.pr.outputs.head_sha }}
          fetch-depth: 0
          persist-credentials: true

      - name: Extract approve signal (product-marketing) from PR diff
        id: approve
        if: steps.pr.outputs.is_open == '1'
        shell: bash
        run: |
          set -euo pipefail
          bus="phosphene/signals/bus.jsonl"
          base="${{ steps.pr.outputs.base_ref }}"
          git fetch origin "$base:refs/remotes/origin/$base" --force
          git diff --unified=0 "origin/$base"...HEAD -- "$bus" \
            | grep -E '^\+' \
            | grep -vE '^\+\+\+' \
            | sed -E 's/^\+//' \
            | grep -E '^\{' \
            > /tmp/pr_new_lines.txt || true

          approve_line="$(node -e '
            const fs=require("fs");
            const raw=fs.existsSync("/tmp/pr_new_lines.txt")?fs.readFileSync("/tmp/pr_new_lines.txt","utf8"):"";
            const lines=raw.split(/\n/).map(l=>l.trim()).filter(Boolean);
            for (const line of lines) {
              try {
                const j=JSON.parse(line);
                if (j.signal_type==="phosphene.detector.product-marketing.approve.v1") {
                  process.stdout.write(line);
                  process.exit(0);
                }
              } catch {}
            }
            process.exit(1);
          ' && true || true)"

          if [[ -z "${approve_line:-}" ]]; then
            echo "has_approve=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          work_id="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.work_id||""));' "$approve_line")"
          issue_number="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.issue_number||""));' "$approve_line")"
          approve_signal_id="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.signal_id||""));' "$approve_line")"

          echo "has_approve=1" >> "$GITHUB_OUTPUT"
          echo "work_id=$work_id" >> "$GITHUB_OUTPUT"
          echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"
          echo "approve_signal_id=$approve_signal_id" >> "$GITHUB_OUTPUT"

      - name: Ensure condenser approve signal exists (product-marketing)
        id: condenser_signal
        if: steps.approve.outputs.has_approve == '1' && steps.pr.outputs.mergeable_state == 'clean' && steps.pr.outputs.is_draft != '1' && steps.pr.outputs.is_open == '1'
        shell: bash
        run: |
          set -euo pipefail
          bus="phosphene/signals/bus.jsonl"
          pr_number="${{ steps.pr.outputs.pr_number }}"
          work_id="${{ steps.approve.outputs.work_id }}"
          issue_number="${{ steps.approve.outputs.issue_number }}"
          approve_signal_id="${{ steps.approve.outputs.approve_signal_id }}"
          lane="beryl"
          domain="product-marketing"
          output_key="condenser:approve:${domain}:pr:${pr_number}"

          signal_id="$(bash phosphene/phosphene-core/bin/signal_hash.sh signal-id --run-marker "$work_id" --output-key "$output_key" --parent "$approve_signal_id")"
          if grep -qF "\"signal_id\":\"${signal_id}\"" "$bus"; then
            echo "has_condenser_signal=1" >> "$GITHUB_OUTPUT"
            echo "did_append=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          created_utc="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          line="{\"signal_version\":1,\"signal_id\":\"${signal_id}\",\"signal_type\":\"phosphene.condenser.product-marketing.approve.v1\",\"work_id\":\"${work_id}\",\"domain\":\"${domain}\",\"issue_number\":${issue_number},\"pr_number\":${pr_number},\"lane\":\"${lane}\",\"parents\":[\"${approve_signal_id}\"],\"run_marker\":\"${work_id}\",\"output_key\":\"${output_key}\",\"ok\":true,\"created_utc\":\"${created_utc}\"}"
          bash phosphene/phosphene-core/bin/signal_bus.sh append --bus "$bus" --line "$line"
          echo "has_condenser_signal=1" >> "$GITHUB_OUTPUT"
          echo "did_append=1" >> "$GITHUB_OUTPUT"

      - name: Commit + push condenser approve signal (product-marketing)
        if: steps.condenser_signal.outputs.did_append == '1'
        shell: bash
        env:
          PHOSPHENE_HUMAN_TOKEN: ${{ secrets.PHOSPHENE_HUMAN_TOKEN }}
        run: |
          set -euo pipefail
          export PHOSPHENE_GANTRY_WRITE_ALLOWLIST=$'phosphene/signals/**\nphosphene/signals/indexes/**'
          bash phosphene/phosphene-core/bin/gantry_write_allowlist_guard.sh check

          if [[ -z "${PHOSPHENE_HUMAN_TOKEN:-}" ]]; then
            echo "PHOSPHENE: missing PHOSPHENE_HUMAN_TOKEN; refusing to push bus changes."
            exit 1
          fi

          pr_number="${{ steps.pr.outputs.pr_number }}"
          head_ref="${{ steps.pr.outputs.head_ref }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${PHOSPHENE_HUMAN_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git add "phosphene/signals/bus.jsonl"
          git commit -m "PHOSPHENE: condenser approve product-marketing for PR #${pr_number}" || exit 0
          git push origin "HEAD:${head_ref}"

      - name: Check for existing condenser approval
        id: review
        if: steps.approve.outputs.has_approve == '1' && steps.condenser_signal.outputs.has_condenser_signal == '1' && steps.condenser_signal.outputs.did_append != '1' && steps.pr.outputs.mergeable_state == 'clean' && steps.pr.outputs.is_draft != '1' && steps.pr.outputs.is_open == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number("${{ steps.pr.outputs.pr_number }}");
            const reviews = await github.rest.pulls.listReviews({ owner, repo, pull_number: pr_number, per_page: 100 });
            const already = (reviews.data || []).some(r => r.user?.login === "github-actions[bot]" && r.state === "APPROVED");
            core.setOutput("already_approved", already ? "1" : "0");

      - name: Approve PR (condenser)
        if: steps.approve.outputs.has_approve == '1' && steps.condenser_signal.outputs.has_condenser_signal == '1' && steps.condenser_signal.outputs.did_append != '1' && steps.pr.outputs.mergeable_state == 'clean' && steps.pr.outputs.is_draft != '1' && steps.pr.outputs.is_open == '1' && steps.review.outputs.already_approved != '1'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number("${{ steps.pr.outputs.pr_number }}");
            await github.rest.pulls.createReview({
              owner,
              repo,
              pull_number: pr_number,
              event: "APPROVE",
              body: "PHOSPHENE: condenser approval (checks green).",
            });

