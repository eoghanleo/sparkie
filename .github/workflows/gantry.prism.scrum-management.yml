name: "gantry.prism.scrum-management"

on:
  push:
    branches: [main]
    paths:
      - "phosphene/signals/bus.jsonl"
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to summon"
        required: true
        type: number
      work_id:
        description: "Work ID (e.g., ISSUE-001)"
        required: true
        type: string
      lane:
        description: "Lane"
        required: true
        type: choice
        options: ["amaranth"]
        default: "amaranth"
      intent:
        description: "Intent string"
        required: true
        type: string
      parent_signal_id:
        description: "Parent signal_id (hopper start signal)"
        required: false
        type: string

permissions:
  issues: write
  contents: write

env:
  # Gantry write boundary: signal bus only.
  PHOSPHENE_GANTRY_WRITE_ALLOWLIST: |
    phosphene/signals/**
    phosphene/signals/indexes/**
  PHOSPHENE_HUMAN_TOKEN: ${{ secrets.PHOSPHENE_HUMAN_TOKEN }}

concurrency:
  group: instrument-prism-scrum-management-${{ inputs.issue_number || github.sha || github.run_id }}
  cancel-in-progress: true

jobs:
  summon:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: false

      - name: Load prism posture config
        id: posture
        shell: bash
        run: |
          set -euo pipefail
          create_branch="$(bash phosphene/phosphene-core/bin/phosphene_config.sh get --color global --key prism.create_branch --default false)"
          create_branch="$(printf "%s" "$create_branch" | tr '[:upper:]' '[:lower:]')"
          if [[ "$create_branch" != "true" && "$create_branch" != "false" ]]; then
            create_branch="false"
          fi
          echo "PHOSPHENE_PRISM_CREATE_BRANCH=$create_branch" >> "$GITHUB_ENV"

      - name: Extract newly added bus lines
        id: diff
        if: github.event_name == 'push'
        shell: bash
        run: |
          set -euo pipefail
          bus="phosphene/signals/bus.jsonl"
          before="${{ github.event.before }}"
          after="${{ github.sha }}"
          git diff --unified=0 "$before" "$after" -- "$bus" \
            | grep -E '^\+' \
            | grep -vE '^\+\+\+' \
            | sed -E 's/^\+//' \
            | grep -E '^\{' \
            > /tmp/new_lines.txt || true
          echo "count=$(wc -l < /tmp/new_lines.txt | tr -d ' ')" >> "$GITHUB_OUTPUT"

      - name: Emit branch-invoked signal + summon Codex
        id: emit
        if: github.event_name != 'push' || steps.diff.outputs.count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const { execFileSync } = require("child_process");
            const crypto = require("crypto");
            const fs = require("fs");
            const { owner, repo } = context.repo;

            const humanToken = String(process.env.PHOSPHENE_HUMAN_TOKEN || "").trim();
            const apiBase = String(process.env.GITHUB_API_URL || "https://api.github.com").replace(/\/+$/, "");
            const apiHeaders = (token) => ({
              accept: "application/vnd.github+json",
              "content-type": "application/json",
              authorization: `token ${token}`,
              "x-github-api-version": "2022-11-28",
            });
            const apiJson = async (path, { method, token, body }) => {
              const resp = await fetch(`${apiBase}${path}`, {
                method,
                headers: apiHeaders(token),
                body: body ? JSON.stringify(body) : undefined,
              });
              const text = await resp.text();
              if (!resp.ok) throw new Error(`GitHub API ${method} ${path} failed: ${resp.status} ${resp.statusText} :: ${text}`);
              return text ? JSON.parse(text) : null;
            };
            const postComment = async ({ issue_number, body }) => {
              if (humanToken) {
                await apiJson(`/repos/${owner}/${repo}/issues/${issue_number}/comments`, {
                  method: "POST",
                  token: humanToken,
                  body: { body },
                });
                return;
              }
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            };

            const slugify = (s) => String(s || "")
              .toLowerCase()
              .trim()
              .replace(/[^a-z0-9]+/g, "-")
              .replace(/^-+|-+$/g, "")
              .slice(0, 60);

            const busPath = "phosphene/signals/bus.jsonl";
            const busText = fs.existsSync(busPath) ? fs.readFileSync(busPath, "utf8") : "";
            const busLines = busText.split(/\r?\n/).map((l) => l.trim()).filter(Boolean);

            const alreadyInvokedForParent = (parent_signal_id) => {
              if (!parent_signal_id) return false;
              for (let i = busLines.length - 1; i >= 0; i--) {
                try {
                  const j = JSON.parse(busLines[i]);
                  if (j?.signal_type !== "phosphene.prism.scrum-management.branch_invoked.v1") continue;
                  const parents = Array.isArray(j.parents) ? j.parents : [];
                  if (parents.includes(parent_signal_id)) return true;
                } catch {}
              }
              return false;
            };

            const emitForStart = async ({ issue_number, work_id, lane, intent, parent_signal_id }) => {
              const issueNum = Number(issue_number || 0);
              const workId = String(work_id || "").trim();
              const ln = String(lane || "amaranth").trim().toLowerCase();
              const it = String(intent || "issue-mirror").trim();
              const parent = String(parent_signal_id || "").trim();
              if (!issueNum || !workId || !parent) return null;

              if (ln !== "amaranth") {
                core.notice(`PHOSPHENE: ignoring scrum-management start signal with non-amaranth lane: ${ln}`);
                return null;
              }

              if (alreadyInvokedForParent(parent)) {
                core.notice(`PHOSPHENE: prism already invoked for parent_signal_id=${parent} (skip).`);
                return null;
              }

              const issueResp = await github.rest.issues.get({ owner, repo, issue_number: issueNum });
              const issueTitle = String(issueResp?.data?.title || "").trim();
              const slug = slugify(issueTitle);
              const branchName = (slug ? `issue-${issueNum}-${slug}` : `issue-${issueNum}`);

              const seed = `${issueNum}:${parent}:${it}`;
              const phos_id = `PHOS-${crypto.createHash("sha256").update(seed).digest("hex").slice(0, 12)}`;
              const created_utc = new Date().toISOString().replace(/\.\d{3}Z$/, "Z");
              const output_key = `prism:branch-invoked:scrum-management:issue:${issueNum}:phos:${phos_id}`;

              const hashArgs = [
                "phosphene/phosphene-core/bin/signal_hash.sh",
                "signal-id",
                "--run-marker",
                workId,
                "--output-key",
                output_key,
                "--parent",
                parent,
              ];
              const signal_id = String(execFileSync("bash", hashArgs, { encoding: "utf8" })).trim();

              const signal = {
                signal_version: 1,
                signal_id,
                signal_type: "phosphene.prism.scrum-management.branch_invoked.v1",
                work_id: workId,
                domain: "scrum-management",
                issue_number: issueNum,
                lane: ln,
                intent: it,
                phos_id,
                parents: [parent],
                run_marker: workId,
                output_key,
                created_utc,
              };

              execFileSync("bash", [
                "phosphene/phosphene-core/bin/signal_bus.sh",
                "append",
                "--bus",
                busPath,
                "--line",
                JSON.stringify(signal),
              ], { stdio: "inherit" });

              const branchLine = `- **branch name (suggested)**: \`${branchName}\``;

              await postComment({
                issue_number: issueNum,
                body: [
                  "@codex take issue.",
                  "",
                  "PHOSPHENE PRISM: branch beam invoked; begin work now.",
                  "",
                  "- **Instrument**: `phosphene:instrument:prism`",
                  `- **work_id**: \`${workId}\``,
                  `- **phos_id**: \`${phos_id}\``,
                  `- **intent**: ${it}`,
                  branchLine,
                  "",
                  "TO AGENT (from prism):",
                  "- Read `phosphene/AGENTS.md`",
                  "- Read `.codex/skills/phosphene/amaranth/scrum-management/modulator/SKILL.md`",
                  "- Use bash-only domain scripts (no hand-editing script-managed artifacts)",
                  "",
                  "**CRITICAL (TO AGENT)**",
                  "- If you create a branch, use the suggested branch name (or a close stable variant) for naming consistency.",
                  "- When ready, push your branch to `origin` (so a human can open the PR).",
                  "- Do NOT open or submit PRs manually (a human opens the PR; condenser approves after checks).",
                  "- When complete, emit a DONE receipt signal (JSONL line) by running:",
                  `  - \`./.codex/skills/phosphene/amaranth/scrum-management/modulator/scripts/scrum-management_emit_done_receipt.sh --issue-number ${issueNum} --work-id ${workId}\``,
                  "  - (this appends to `phosphene/signals/bus.jsonl` in your branch; it must parent this prism signal)",
                ].join("\n"),
              });

              return { issue_number: issueNum, phos_id };
            };

            const emitted = [];
            if (context.eventName === "workflow_dispatch") {
              const issue_number = Number(core.getInput("issue_number", { required: true }));
              const work_id = String(core.getInput("work_id", { required: true })).trim();
              const lane = String(core.getInput("lane", { required: true })).trim().toLowerCase();
              const intent = String(core.getInput("intent", { required: true })).trim();
              const parent_signal_id = String(core.getInput("parent_signal_id") || "").trim();
              const out = await emitForStart({ issue_number, work_id, lane, intent, parent_signal_id });
              if (out) emitted.push(out);
            } else if (context.eventName === "push") {
              const raw = fs.existsSync("/tmp/new_lines.txt") ? fs.readFileSync("/tmp/new_lines.txt", "utf8") : "";
              const lines = raw.split(/\n/).filter(Boolean);
              for (const line of lines) {
                let j;
                try { j = JSON.parse(line); } catch { continue; }
                if (String(j.signal_type || "") !== "phosphene.hopper.scrum-management.start.v1") continue;
                const out = await emitForStart({
                  issue_number: j.issue_number,
                  work_id: j.work_id,
                  lane: j.lane,
                  intent: j.intent,
                  parent_signal_id: j.signal_id,
                });
                if (out) emitted.push(out);
              }
            }

            if (emitted.length === 0) {
              core.notice("PHOSPHENE: no prism work performed (no matching start signals or all deduped).");
              return;
            }

            core.setOutput("did_append", "1");
            core.setOutput("issues", emitted.map((e) => String(e.issue_number)).join(","));
            core.notice(`PHOSPHENE: prism invoked for issue(s): ${emitted.map((e) => `#${e.issue_number}`).join(", ")}`);

      - name: Commit + push bus append
        if: steps.emit.outputs.did_append == '1'
        shell: bash
        run: |
          set -euo pipefail

          export PHOSPHENE_GANTRY_WRITE_ALLOWLIST=$'phosphene/signals/**\nphosphene/signals/indexes/**'
          bash phosphene/phosphene-core/bin/gantry_write_allowlist_guard.sh check

          if [[ -z "${PHOSPHENE_HUMAN_TOKEN:-}" ]]; then
            echo "PHOSPHENE: missing PHOSPHENE_HUMAN_TOKEN; refusing to push bus changes (would suppress downstream workflows)."
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${PHOSPHENE_HUMAN_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          if git diff --quiet -- "phosphene/signals/bus.jsonl"; then
            echo "PHOSPHENE: bus.jsonl unchanged; nothing to commit."
            exit 0
          fi

          git add "phosphene/signals/bus.jsonl"
          git commit -m "PHOSPHENE: prism scrum-management branch invoked for issue(s) ${{ steps.emit.outputs.issues }}"
          git push origin HEAD:main
